<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- 強力なキャッシュ無効化設定 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="16:9 Clock V3">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23f4f4f4'/%3E%3Ccircle cx='256' cy='256' r='200' fill='none' stroke='%231a1a1a' stroke-width='40'/%3E%3Cline x1='256' y1='256' x2='256' y2='100' stroke='%231a1a1a' stroke-width='30' stroke-linecap='round'/%3E%3Cline x1='256' y1='256' x2='380' y2='256' stroke='%23666666' stroke-width='20' stroke-linecap='round'/%3E%3Ccircle cx='256' cy='256' r='20' fill='%231a1a1a'/%3E%3C/svg%3E">
    
    <title>Monotone Clock V3 (No Cache)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;800&family=Noto+Sans+JP:wght@400;700&display=swap');

        :root {
            --bg-base: #f4f4f4;
            --bg-gradient: #ffffff;
            --ink-black: #1a1a1a;
            --slate-gray: #666666;
            --soft-gray: #e0e0e0;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-base);
            background: radial-gradient(circle at center, var(--bg-gradient) 0%, var(--bg-base) 100%);
            color: var(--ink-black);
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
            
            /* 全体を右にずらす */
            padding-left: 20px; 
        }

        .main-layout {
            display: flex;
            width: 96vw;
            height: 100vh;
            margin: 0 auto;
            align-items: center;
            justify-content: space-between;
        }

        /* === 左側：時計と天気 (60%) === */
        .left-column {
            width: 62%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            z-index: 10;
            padding-top: 5vh;
            animation: float 6s ease-in-out infinite;
        }

        /* 時計 */
        .clock-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 6vh;
        }

        .date-section {
            font-size: 2.2vw;
            font-weight: 500;
            letter-spacing: 0.1em;
            color: var(--slate-gray);
            margin-bottom: -1vh;
            display: flex;
            gap: 1vw;
            opacity: 0.9;
            padding-left: 0.5vw;
        }

        .day-highlight {
            font-weight: 700;
            color: var(--ink-black);
        }

        .time-wrapper {
            display: flex;
            align-items: baseline;
            line-height: 1;
            margin-top: 1vh;
        }

        .time-section {
            font-size: 18vw; 
            font-weight: 800;
            letter-spacing: -0.05em;
            color: var(--ink-black);
            font-variant-numeric: tabular-nums;
            text-shadow: 0 10px 40px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }

        .separator {
            opacity: 0.15;
            margin: 0 0.5vw; 
            transform: translateY(-2vw);
        }

        .seconds {
            font-family: 'Poppins', sans-serif;
            font-size: 5.5vw; 
            font-weight: 600;
            color: var(--slate-gray);
            margin-left: 1.5vw;
            opacity: 0.8;
            width: 7.5vw; 
            text-align: left;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
        }

        /* 天気バー */
        .weather-bar {
            display: flex;
            align-items: center;
            gap: 2.5vw;
            padding-left: 1vw;
            animation: fadeIn 2s ease-out;
            width: 100%;
        }

        .current-weather-group {
            display: flex;
            align-items: center;
            gap: 1vw;
            padding-right: 2.5vw;
            border-right: 2px solid rgba(0,0,0,0.1);
        }

        .current-icon {
            width: 6vw;
            height: 6vw;
        }

        .current-temp-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .location-label {
            font-size: 0.9vw;
            font-weight: 700;
            color: var(--slate-gray);
            letter-spacing: 0.05em;
        }

        .current-temp-big {
            font-size: 3.5vw;
            font-weight: 700;
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .hourly-scroll {
            display: flex;
            align-items: center;
            gap: 2vw;
        }

        .hourly-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5vh;
            width: 4.5vw;
        }

        .hourly-icon {
            width: 2.5vw;
            height: 2.5vw;
        }

        .hourly-time {
            font-size: 0.9vw;
            font-weight: 600;
            color: var(--slate-gray);
        }

        .hourly-temp {
            font-size: 1.4vw;
            font-weight: 700;
        }

        /* === 右側：カレンダー (38%) === */
        .right-column {
            width: 38%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-left: 4px solid var(--ink-black);
            padding-left: 3vw;
        }

        .calendar-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calendar-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 2vh;
        }

        .calendar-title {
            font-size: 2.2vw;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .calendar-nav {
            display: flex;
            gap: 1.5vw;
        }

        .cal-btn {
            font-size: 4vw;
            font-weight: 700;
            cursor: pointer;
            color: var(--slate-gray);
            user-select: none;
            transition: all 0.2s;
            padding: 0 0.5vw;
            line-height: 1;
        }
        .cal-btn:hover { color: var(--ink-black); transform: scale(1.1); }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1vh 0.2vw;
            width: 100%;
            text-align: center;
        }

        .cal-day-name {
            font-size: 1.3vw;
            font-weight: 600;
            color: var(--slate-gray);
            margin-bottom: 0.5vh;
        }

        .cal-date {
            font-size: 1.8vw;
            font-weight: 500;
            width: 3.5vw;
            height: 3.5vw;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            margin: 0 auto;
        }

        .cal-today {
            background-color: var(--ink-black);
            color: var(--bg-base);
            font-weight: 700;
        }

        .weather-svg {
            width: 100%;
            height: 100%;
            fill: var(--ink-black);
            stroke: var(--ink-black);
            stroke-width: 0.5px;
            filter: drop-shadow(1px 2px 4px rgba(0,0,0,0.1));
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--soft-gray);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #888888, #1a1a1a);
            width: 0%;
            border-radius: 0 4px 4px 0;
            transition: width 0.1s linear;
        }

        .hint-text {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--slate-gray);
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body onclick="toggleFullScreen()">

    <div id="hint" class="hint-text">TAP TO FULLSCREEN</div>

    <div class="main-layout">
        <div class="left-column">
            
            <div class="clock-wrapper">
                <div class="date-section">
                    <span id="date">LOADING</span>
                    <span id="day" class="day-highlight"></span>
                </div>
                <div class="time-wrapper">
                    <div class="time-section">
                        <span id="hours">00</span>
                        <span class="separator">:</span>
                        <span id="minutes">00</span>
                    </div>
                    <div class="seconds" id="seconds">00</div>
                </div>
            </div>

            <div class="weather-bar">
                <div class="current-weather-group">
                    <div class="current-icon" id="main-icon"></div>
                    <div class="current-temp-info">
                        <span class="location-label">SHIBATA</span>
                        <span class="current-temp-big" id="main-temp">--°</span>
                    </div>
                </div>

                <div class="hourly-scroll" id="hourly-forecast">
                    <div class="hourly-item"><span class="hourly-time">6</span></div>
                    <div class="hourly-item"><span class="hourly-time">9</span></div>
                    <div class="hourly-item"><span class="hourly-time">12</span></div>
                    <div class="hourly-item"><span class="hourly-time">15</span></div>
                    <div class="hourly-item"><span class="hourly-time">18</span></div>
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="calendar-container">
                <div class="calendar-header-row">
                    <span class="calendar-title" id="cal-header">Month Year</span>
                    <div class="calendar-nav">
                        <div class="cal-btn" onclick="changeMonth(-1); event.stopPropagation();">&lt;</div>
                        <div class="cal-btn" onclick="changeMonth(1); event.stopPropagation();">&gt;</div>
                    </div>
                </div>
                <div class="calendar-grid" id="cal-grid">
                </div>
            </div>
        </div>
    </div>

    <div class="progress-bar-container">
        <div class="progress-bar" id="progress"></div>
    </div>

    <script>
        function setupManifest() {
            const iconData = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23f4f4f4'/%3E%3Ccircle cx='256' cy='256' r='200' fill='none' stroke='%231a1a1a' stroke-width='40'/%3E%3Cline x1='256' y1='256' x2='256' y2='100' stroke='%231a1a1a' stroke-width='30' stroke-linecap='round'/%3E%3Cline x1='256' y1='256' x2='380' y2='256' stroke='%23666666' stroke-width='20' stroke-linecap='round'/%3E%3Ccircle cx='256' cy='256' r='20' fill='%231a1a1a'/%3E%3C/svg%3E";
            // キャッシュ対策としてURLにタイムスタンプを付与
            const startUrl = window.location.href + "?v=" + new Date().getTime();
            
            const manifest = {
                "name": "Monotone V3",
                "short_name": "Clock",
                "start_url": startUrl,
                "display": "fullscreen",
                "background_color": "#f4f4f4",
                "theme_color": "#f4f4f4",
                "orientation": "landscape",
                "icons": [{ "src": iconData, "sizes": "512x512", "type": "image/svg+xml" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.querySelector('#manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e=>{});
                document.getElementById('hint').style.opacity = '0';
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }

        function updateClock() {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const pad = (num) => String(num).padStart(2, '0');

            const year = now.getFullYear();
            const monthName = months[now.getMonth()];
            const date = pad(now.getDate());
            const dayName = days[now.getDay()];

            const h = pad(now.getHours());
            const m = pad(now.getMinutes());
            const s = pad(now.getSeconds());
            const progressPercent = ((now.getSeconds() + now.getMilliseconds() / 1000) / 60) * 100;

            document.getElementById('date').textContent = `${monthName} ${date}, ${year}`;
            document.getElementById('day').textContent = dayName;
            document.getElementById('hours').textContent = h;
            document.getElementById('minutes').textContent = m;
            document.getElementById('seconds').textContent = s;
            document.getElementById('progress').style.width = `${progressPercent}%`;
        }

        const API_URL = "https://api.open-meteo.com/v1/forecast?latitude=37.9485&longitude=139.3297&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&timezone=Asia%2FTokyo";
        const viewboxSetting = "-10 -10 84 84";
        const icons = {
            sun: `<svg class="weather-svg" viewBox="${viewboxSetting}"><circle cx="32" cy="32" r="14" stroke="currentColor" stroke-width="5" fill="none"/><path d="M32 6V12 M32 52V58 M58 32H52 M12 32H6 M50.4 13.6L46.1 17.9 M17.9 46.1L13.6 50.4 M50.4 50.4L46.1 46.1 M17.9 17.9L13.6 13.6" stroke="currentColor" stroke-width="5" stroke-linecap="round"/></svg>`,
            cloud: `<svg class="weather-svg" viewBox="${viewboxSetting}"><path d="M16 46H48C55.7 46 62 39.7 62 32C62 24.3 55.7 18 48 18C47.1 18 46.2 18.1 45.4 18.3C43.5 10.4 36.4 4.5 28 4.5C18.1 4.5 10 12.6 10 22.5C10 23.3 10.1 24 10.2 24.8C5.2 26.2 1.5 30.8 1.5 36.2C1.5 41.6 5.9 46 11.3 46H16Z" fill="none" stroke="currentColor" stroke-width="5" stroke-linejoin="round"/></svg>`,
            rain: `<svg class="weather-svg" viewBox="${viewboxSetting}"><path d="M16 40H48C55.7 40 62 33.7 62 26C62 18.3 55.7 12 48 12C47.1 12 46.2 12.1 45.4 12.3C43.5 4.4 36.4 -1.5 28 -1.5C18.1 -1.5 10 6.6 10 16.5C10 17.3 10.1 18 10.2 18.8C5.2 20.2 1.5 24.8 1.5 30.2C1.5 35.6 5.9 40 11.3 40H16Z" fill="none" stroke="currentColor" stroke-width="5"/><path d="M22 48L18 58 M32 48L28 58 M42 48L38 58" stroke="currentColor" stroke-width="5" stroke-linecap="round"/></svg>`,
            snow: `<svg class="weather-svg" viewBox="${viewboxSetting}"><path d="M32 12V52 M14 22L50 42 M14 42L50 22" stroke="currentColor" stroke-width="5" stroke-linecap="round"/><circle cx="32" cy="32" r="2" fill="currentColor"/></svg>`,
            thunder: `<svg class="weather-svg" viewBox="${viewboxSetting}"><path d="M16 40H48C55.7 40 62 33.7 62 26C62 18.3 55.7 12 48 12C47.1 12 46.2 12.1 45.4 12.3C43.5 4.4 36.4 -1.5 28 -1.5C18.1 -1.5 10 6.6 10 16.5C10 17.3 10.1 18 10.2 18.8C5.2 20.2 1.5 24.8 1.5 30.2C1.5 35.6 5.9 40 11.3 40H16Z" fill="none" stroke="currentColor" stroke-width="5"/><path d="M34 38L26 50H36L30 62" stroke="currentColor" stroke-width="5" stroke-linejoin="round"/></svg>`
        };

        function getWeatherDetails(code) {
            if (code === 0) return { icon: icons.sun };
            if (code <= 3) return { icon: icons.cloud };
            if (code <= 48) return { icon: icons.cloud };
            if (code <= 67) return { icon: icons.rain };
            if (code <= 77) return { icon: icons.snow };
            if (code <= 82) return { icon: icons.rain };
            if (code <= 99) return { icon: icons.thunder };
            return { icon: icons.cloud };
        }

        async function fetchWeather() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                const currentHour = new Date().getHours();
                
                // --- 現在の天気 ---
                const currentTemp = Math.round(data.current.temperature_2m);
                const currentIcon = getWeatherDetails(data.current.weather_code).icon;
                
                document.getElementById('main-icon').innerHTML = currentIcon;
                document.getElementById('main-temp').textContent = currentTemp + "°";

                // --- 時間ごとの予報 ---
                const hourlyContainer = document.getElementById('hourly-forecast');
                hourlyContainer.innerHTML = ''; 
                
                const isTomorrowMode = currentHour >= 19;
                const offset = isTomorrowMode ? 24 : 0;
                const targetHours = [6, 9, 12, 15, 18];
                const hourlyTemps = data.hourly.temperature_2m;
                const hourlyCodes = data.hourly.weather_code;

                targetHours.forEach(hour => {
                    const index = hour + offset;
                    if (index < hourlyTemps.length) {
                        const temp = Math.round(hourlyTemps[index]);
                        const code = hourlyCodes[index];
                        const details = getWeatherDetails(code);
                        const div = document.createElement('div');
                        div.className = 'hourly-item';
                        div.innerHTML = `<div class="hourly-icon">${details.icon}</div><span class="hourly-time">${hour}</span><span class="hourly-temp">${temp}°</span>`;
                        hourlyContainer.appendChild(div);
                    }
                });
            } catch (e) { console.error("Weather fetch failed", e); }
        }

        // --- カレンダー ---
        let displayDate = new Date(); 

        function renderCalendar() {
            const now = new Date();
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();
            
            const isCurrentMonth = (now.getFullYear() === year && now.getMonth() === month);
            const todayDate = now.getDate();

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('cal-header').textContent = `${monthNames[month]} ${year}`;

            const grid = document.getElementById('cal-grid');
            grid.innerHTML = '';

            const dayNames = ["S", "M", "T", "W", "T", "F", "S"];
            dayNames.forEach(d => {
                const el = document.createElement('div');
                el.className = 'cal-day-name';
                el.textContent = d;
                grid.appendChild(el);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const el = document.createElement('div');
                el.className = 'cal-date';
                el.textContent = i;
                if (isCurrentMonth && i === todayDate) el.classList.add('cal-today');
                grid.appendChild(el);
            }
        }

        function changeMonth(delta) {
            displayDate.setMonth(displayDate.getMonth() + delta);
            renderCalendar();
        }

        // --- 初期化 ---
        setupManifest();
        setInterval(updateClock, 30);
        updateClock();
        fetchWeather();
        setInterval(fetchWeather, 300000);
        renderCalendar();
    </script>
</body>
</html>
